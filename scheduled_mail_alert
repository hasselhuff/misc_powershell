
$command ={
'$username = "<sending email address>"
$pwdTxt = "01000000d08c9ddf0115d1118c7a00c04fc297eb01000000f74a7c9a089d874fae7c16b927cb76a60000000002000000000003660000c0000000100000002b9d6d00c27c22ca8749b48c2b3886c90000000004800000a0000000100000005b6454e87b1d8fd22243a1488c752e0b20000000db8228ca8194fc678aa5308d749766c08fb0b72b072eac61d859d9be1be4777814000000daa1c3db7e7428957d4cccf87837fb999b1fccbb"
$securePwd = $pwdTxt | ConvertTo-SecureString 
$credObject = New-Object System.Management.Automation.PSCredential -ArgumentList $username, $securePwd
Send-MailMessage -Credential $credObject -To <insert recieving email address -From <sending email address> -Subject "$env:computername has been set to shutdown" -Body "If this was unexpected please log into the server and check the cause as soon as possible." -SmtpServer smtp.office365.com -Port 587 -DeliveryNotificationOption OnFailure,OnSuccess -UseSsl'}

$bytes = [system.text.encoding]::Unicode.GetBytes($command)

$encodedCommand = [convert]::tobase64string($bytes)

echo $encodedCommand
DQAKACcAJAB1AHMAZQByAG4AYQBtAGUAIAA9ACAAIgBhAGwAZQByAHQAQABoAGUAYQBsAHQAaAB0AGUAYwBoAHMAbwBsAHUAdABpAG8AbgBzAC4AYwBvAG0AIgANAAoAJABwAHcAZABUAHgAdAAgAD0AIAAiADAAMQAwADAAMAAwADAAMABkADAAOABjADkAZABkAGYAMAAxADEANQBkADEAMQAxADgAYwA3AGEAMAAwAGMAMAA0AGYAYwAyADkANwBlAGIAMAAxADAAMAAwADAAMAAwAGYANwA0AGEANwBjADkAYQAwADgAOQBkADgANwA0AGYAYQBlADcAYwAxADYAYgA5ADIANwBjAGIANwA2AGEANgAwADAAMAAwADAAMAAwADAAMAAyADAAMAAwADAAMAAwADAAMAAwADAAMAAzADYANgAwADAAMAAwAGMAMAAwADAAMAAwADAAMAAxADAAMAAwADAAMAAwADAAMgBiADkAZAA2AGQAMAAwAGMAMgA3AGMAMgAyAGMAYQA4ADcANAA5AGIANAA4AGMAMgBiADMAOAA4ADYAYwA5ADAAMAAwADAAMAAwADAAMAAwADQAOAAwADAAMAAwADAAYQAwADAAMAAwADAAMAAwADEAMAAwADAAMAAwADAAMAA1AGIANgA0ADUANABlADgANwBiADEAZAA4AGYAZAAyADIAMgA0ADMAYQAxADQAOAA4AGMANwA1ADIAZQAwAGIAMgAwADAAMAAwADAAMAAwAGQAYgA4ADIAMgA4AGMAYQA4ADEAOQA0AGYAYwA2ADcAOABhAGEANQAzADAAOABkADcANAA5ADcANgA2AGMAMAA4AGYAYgAwAGIANwAyAGIAMAA3ADIAZQBhAGMANgAxAGQAOAA1ADkAZAA5AGIAZQAxAGIAZQA0ADcANwA3ADgAMQA0ADAAMAAwADAAMAAwAGQAYQBhADEAYwAzAGQAYgA3AGUANwA0ADIAOAA5ADUANwBkADQAYwBjAGMAZgA4ADcAOAAzADcAZgBiADkAOQA5AGIAMQBmAGMAYwBiAGIAIgANAAoAJABzAGUAYwB1AHIAZQBQAHcAZAAgAD0AIAAkAHAAdwBkAFQAeAB0ACAAfAAgAEMAbwBuAHYAZQByAHQAVABvAC0AUwBlAGMAdQByAGUAUwB0AHIAaQBuAGcAIAANAAoAJABjAHIAZQBkAE8AYgBqAGUAYwB0ACAAPQAgAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAE0AYQBuAGEAZwBlAG0AZQBuAHQALgBBAHUAdABvAG0AYQB0AGkAbwBuAC4AUABTAEMAcgBlAGQAZQBuAHQAaQBhAGwAIAAtAEEAcgBnAHUAbQBlAG4AdABMAGkAcwB0ACAAJAB1AHMAZQByAG4AYQBtAGUALAAgACQAcwBlAGMAdQByAGUAUAB3AGQADQAKAFMAZQBuAGQALQBNAGEAaQBsAE0AZQBzAHMAYQBnAGUAIAAtAEMAcgBlAGQAZQBuAHQAaQBhAGwAIAAkAGMAcgBlAGQATwBiAGoAZQBjAHQAIAAtAFQAbwAgAHQAdQBjAGsAZQByAC4AaAB1AGYAZgBAAGgAZQBhAGwAdABoAHQAZQBjAGgAcwBvAGwAdQB0AGkAbwBuAHMALgBjAG8AbQAgAC0ARgByAG8AbQAgAGEAbABlAHIAdABAAGgAZQBhAGwAdABoAHQAZQBjAGgAcwBvAGwAdQB0AGkAbwBuAHMALgBjAG8AbQAgAC0AUwB1AGIAagBlAGMAdAAgACIAJABlAG4AdgA6AGMAbwBtAHAAdQB0AGUAcgBuAGEAbQBlACAAaABhAHMAIABiAGUAZQBuACAAcwBlAHQAIAB0AG8AIABzAGgAdQB0AGQAbwB3AG4AIgAgAC0AQgBvAGQAeQAgACIASQBmACAAdABoAGkAcwAgAHcAYQBzACAAdQBuAGUAeABwAGUAYwB0AGUAZAAgAHAAbABlAGEAcwBlACAAbABvAGcAIABpAG4AdABvACAAdABoAGUAIABzAGUAcgB2AGUAcgAgAGEAbgBkACAAYwBoAGUAYwBrACAAdABoAGUAIABjAGEAdQBzAGUAIABhAHMAIABzAG8AbwBuACAAYQBzACAAcABvAHMAcwBpAGIAbABlAC4AIgAgAC0AUwBtAHQAcABTAGUAcgB2AGUAcgAgAHMAbQB0AHAALgBvAGYAZgBpAGMAZQAzADYANQAuAGMAbwBtACAALQBQAG8AcgB0ACAANQA4ADcAIAAtAEQAZQBsAGkAdgBlAHIAeQBOAG8AdABpAGYAaQBjAGEAdABpAG8AbgBPAHAAdABpAG8AbgAgAE8AbgBGAGEAaQBsAHUAcgBlACwATwBuAFMAdQBjAGMAZQBzAHMAIAAtAFUAcwBlAFMAcwBsACcA

# PowerShell command line for Task SCheduler
$class = cimclass MSFT_TaskEventTrigger root/Microsoft/Windows/TaskScheduler
$trigger = $class | New-CimInstance -ClientOnly
$trigger.Enabled = $true
$trigger.Subscription = '<QueryList><Query Id="0" Path="System"><Select Path="System">*[System[Provider[@Name=''System/EventLog''] and EventID=6006]]</Select></Query></QueryList>'

$ActionParameters = @{
    Execute  = 'C:\Windows\system32\WindowsPowerShell\v1.0\powershell.exe'
    Argument = '-encodedcommand DQAKACQAdQBzAGUAcgBuAGEAbQBlACAAPQAgACIAYQBsAGUAcgB0AEAAaABlAGEAbAB0AGgAdABlAGMAaABzAG8AbAB1AHQAaQBvAG4AcwAuAGMAbwBtACIADQAKACQAcAB3AGQAVAB4AHQAIAA9ACAAIgAwADEAMAAwADAAMAAwADAAZAAwADgAYwA5AGQAZABmADAAMQAxADUAZAAxADEAMQA4AGMANwBhADAAMABjADAANABmAGMAMgA5ADcAZQBiADAAMQAwADAAMAAwADAAMABmADcANABhADcAYwA5AGEAMAA4ADkAZAA4ADcANABmAGEAZQA3AGMAMQA2AGIAOQAyADcAYwBiADcANgBhADYAMAAwADAAMAAwADAAMAAwADAAMgAwADAAMAAwADAAMAAwADAAMAAwADAAMwA2ADYAMAAwADAAMABjADAAMAAwADAAMAAwADAAMQAwADAAMAAwADAAMAAwADIAYgA5AGQANgBkADAAMABjADIANwBjADIAMgBjAGEAOAA3ADQAOQBiADQAOABjADIAYgAzADgAOAA2AGMAOQAwADAAMAAwADAAMAAwADAAMAA0ADgAMAAwADAAMAAwAGEAMAAwADAAMAAwADAAMAAxADAAMAAwADAAMAAwADAANQBiADYANAA1ADQAZQA4ADcAYgAxAGQAOABmAGQAMgAyADIANAAzAGEAMQA0ADgAOABjADcANQAyAGUAMABiADIAMAAwADAAMAAwADAAMABkAGIAOAAyADIAOABjAGEAOAAxADkANABmAGMANgA3ADgAYQBhADUAMwAwADgAZAA3ADQAOQA3ADYANgBjADAAOABmAGIAMABiADcAMgBiADAANwAyAGUAYQBjADYAMQBkADgANQA5AGQAOQBiAGUAMQBiAGUANAA3ADcANwA4ADEANAAwADAAMAAwADAAMABkAGEAYQAxAGMAMwBkAGIANwBlADcANAAyADgAOQA1ADcAZAA0AGMAYwBjAGYAOAA3ADgAMwA3AGYAYgA5ADkAOQBiADEAZgBjAGMAYgBiACIADQAKACQAcwBlAGMAdQByAGUAUAB3AGQAIAA9ACAAJABwAHcAZABUAHgAdAAgAHwAIABDAG8AbgB2AGUAcgB0AFQAbwAtAFMAZQBjAHUAcgBlAFMAdAByAGkAbgBnACAADQAKACQAYwByAGUAZABPAGIAagBlAGMAdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAFAAUwBDAHIAZQBkAGUAbgB0AGkAYQBsACAALQBBAHIAZwB1AG0AZQBuAHQATABpAHMAdAAgACQAdQBzAGUAcgBuAGEAbQBlACwAIAAkAHMAZQBjAHUAcgBlAFAAdwBkAA0ACgBTAGUAbgBkAC0ATQBhAGkAbABNAGUAcwBzAGEAZwBlACAALQBDAHIAZQBkAGUAbgB0AGkAYQBsACAAJABjAHIAZQBkAE8AYgBqAGUAYwB0ACAALQBUAG8AIAB0AHUAYwBrAGUAcgAuAGgAdQBmAGYAQABoAGUAYQBsAHQAaAB0AGUAYwBoAHMAbwBsAHUAdABpAG8AbgBzAC4AYwBvAG0AIAAtAEYAcgBvAG0AIABhAGwAZQByAHQAQABoAGUAYQBsAHQAaAB0AGUAYwBoAHMAbwBsAHUAdABpAG8AbgBzAC4AYwBvAG0AIAAtAFMAdQBiAGoAZQBjAHQAIAAiACQAZQBuAHYAOgBjAG8AbQBwAHUAdABlAHIAbgBhAG0AZQAgAGgAYQBzACAAYgBlAGUAbgAgAHMAZQB0ACAAdABvACAAcwBoAHUAdABkAG8AdwBuACIAIAAtAEIAbwBkAHkAIAAiAEkAZgAgAHQAaABpAHMAIAB3AGEAcwAgAHUAbgBlAHgAcABlAGMAdABlAGQAIABwAGwAZQBhAHMAZQAgAGwAbwBnACAAaQBuAHQAbwAgAHQAaABlACAAcwBlAHIAdgBlAHIAIABhAG4AZAAgAGMAaABlAGMAawAgAHQAaABlACAAYwBhAHUAcwBlACAAYQBzACAAcwBvAG8AbgAgAGEAcwAgAHAAbwBzAHMAaQBiAGwAZQAuACIAIAAtAFMAbQB0AHAAUwBlAHIAdgBlAHIAIABzAG0AdABwAC4AbwBmAGYAaQBjAGUAMwA2ADUALgBjAG8AbQAgAC0AUABvAHIAdAAgADUAOAA3ACAALQBEAGUAbABpAHYAZQByAHkATgBvAHQAaQBmAGkAYwBhAHQAaQBvAG4ATwBwAHQAaQBvAG4AIABPAG4ARgBhAGkAbAB1AHIAZQAsAE8AbgBTAHUAYwBjAGUAcwBzACAALQBVAHMAZQBTAHMAbAA='
}
$Action = New-ScheduledTaskAction @ActionParameters
$Principal = New-ScheduledTaskPrincipal -UserId 'NT AUTHORITY\SYSTEM' -LogonType ServiceAccount
$Settings = New-ScheduledTaskSettingsSet

$RegSchTaskParameters = @{
    TaskName    = 'Shutdown Alert'
    Description = 'Email an alert when the host shutdowns'
    TaskPath    = '\Event Viewer Tasks\'
    Action      = $Action
    Principal   = $Principal
    Settings    = $Settings
    Trigger     = $Trigger
}
Register-ScheduledTask @RegSchTaskParameters
